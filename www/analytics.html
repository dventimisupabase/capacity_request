<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Analytics</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html">Dashboard</a>
        <a href="new.html">New Request</a>
        <a href="queue.html">Queue <span class="nav-badge" id="queue-badge"></span></a>
        <a href="analytics.html" class="active">Analytics</a>
      </nav>
      <span class="topbar-user"><span id="user-info"></span><button class="topbar-signout" onclick="signOut()" title="Sign out">Sign out</button></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Sign in with your Slack workspace account.</p>
      <button class="btn btn-primary btn-slack" onclick="signInWithSlack()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.163 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.163 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.163 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.523 2.527 2.527 0 0 1 2.52-2.52h6.315A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.315z"/></svg>
        Sign in with Slack
      </button>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Analytics</h1>
        <p>Capacity request metrics and trends</p>
      </div>

      <div id="msg"></div>

      <div class="chart-grid fade-in fade-in-1">
        <div class="chart-card">
          <div class="card-header"><h3>Requests by State</h3></div>
          <div class="card-body"><canvas id="chart-state"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>Approval Latency (hours)</h3></div>
          <div class="card-body"><canvas id="chart-latency"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>Cost by Region</h3></div>
          <div class="card-body"><canvas id="chart-region"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>Request Volume</h3></div>
          <div class="card-body"><canvas id="chart-volume"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>Time in State (hours)</h3></div>
          <div class="card-body"><canvas id="chart-time-state"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>VP Escalation Rate</h3></div>
          <div class="card-body"><canvas id="chart-escalation"></canvas></div>
        </div>
      </div>

      <footer class="app-footer fade-in fade-in-3">
        <p>Analytics are computed from all capacity requests. Charts update on page load.</p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const COLORS = {
      amber:  '#f59e0b',
      green:  '#22c55e',
      red:    '#ef4444',
      blue:   '#38bdf8',
      purple: '#a78bfa',
      muted:  '#8888a0'
    };
    const PALETTE = [COLORS.amber, COLORS.green, COLORS.red, COLORS.blue, COLORS.purple, COLORS.muted, '#f472b6', '#34d399', '#fb923c'];

    // Chart.js global defaults for dark theme
    Chart.defaults.color = '#8888a0';
    Chart.defaults.borderColor = '#2a2a3a';
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.padding = 12;

    async function init() {
      try {
        if (SUPABASE_ANON_KEY.includes('secret')) {
          showApp({ email: 'local-dev', id: 'local-dev' });
          return;
        }
        const { data: { session } } = await sb.auth.getSession();
        if (session) showApp(session.user);
        sb.auth.onAuthStateChange((_event, session) => {
          if (session) showApp(session.user);
        });
      } catch (e) {
        console.error('init error:', e);
        showApp({ email: 'fallback', id: 'fallback' });
      }
    }

    async function signInWithSlack() {
      const { data, error } = await sb.auth.signInWithOAuth({
        provider: 'slack_oidc',
        options: { redirectTo: window.location.href }
      });
      if (error) {
        const msg = document.getElementById('auth-msg');
        msg.classList.remove('hidden');
        msg.className = 'msg msg-error mt-2';
        msg.textContent = error.message;
      }
    }

    async function signOut() {
      await sb.auth.signOut();
      location.reload();
    }

    function getSlackUserId(user) {
      if (user.user_metadata?.provider_id) return user.user_metadata.provider_id;
      const slack = user.identities?.find(i => i.provider === 'slack_oidc');
      if (slack?.identity_data?.provider_id) return slack.identity_data.provider_id;
      if (user.user_metadata?.sub) return user.user_metadata.sub;
      return user.id || user.email;
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      const displayName = user.user_metadata?.name || user.user_metadata?.full_name || user.email;
      document.getElementById('user-info').textContent = displayName;
      window._userId = getSlackUserId(user);
      await loadCharts();
    }

    function parseInterval(s) {
      if (!s) return 0;
      let hours = 0;
      const dayMatch = s.match(/(\d+)\s*day/);
      if (dayMatch) hours += parseInt(dayMatch[1]) * 24;
      const timeMatch = s.match(/(\d+):(\d+):(\d+)/);
      if (timeMatch) {
        hours += parseInt(timeMatch[1]);
        hours += parseInt(timeMatch[2]) / 60;
      }
      return Math.round(hours * 10) / 10;
    }

    async function loadCharts() {
      const [summaryRes, latencyRes, timeStateRes] = await Promise.all([
        sb.from('v_request_summary').select('*'),
        sb.from('v_approval_latency').select('*'),
        sb.from('v_time_in_state').select('*')
      ]);

      const summary = summaryRes.data || [];
      const latency = latencyRes.data || [];
      const timeState = timeStateRes.data || [];

      // 1. Requests by State (Doughnut)
      const stateCounts = {};
      summary.forEach(r => { stateCounts[r.state] = (stateCounts[r.state] || 0) + 1; });
      const stateLabels = Object.keys(stateCounts);
      new Chart(document.getElementById('chart-state'), {
        type: 'doughnut',
        data: {
          labels: stateLabels.map(s => s.replace(/_/g, ' ')),
          datasets: [{
            data: stateLabels.map(s => stateCounts[s]),
            backgroundColor: stateLabels.map((_, i) => PALETTE[i % PALETTE.length]),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });

      // 2. Approval Latency (Horizontal Bar)
      const latencyLabels = [];
      const latencyValues = [];
      const latencyColors = [COLORS.amber, COLORS.blue, COLORS.purple];
      latency.forEach((row, i) => {
        latencyLabels.push(row.approval_stage || row.stage || ('Stage ' + (i + 1)));
        latencyValues.push(parseInterval(row.avg_latency || row.average_latency));
      });
      if (latencyLabels.length === 0) {
        latencyLabels.push('Commercial', 'Technical', 'VP');
        latencyValues.push(0, 0, 0);
      }
      new Chart(document.getElementById('chart-latency'), {
        type: 'bar',
        data: {
          labels: latencyLabels,
          datasets: [{
            label: 'Avg Hours',
            data: latencyValues,
            backgroundColor: latencyLabels.map((_, i) => latencyColors[i % latencyColors.length]),
            borderWidth: 0
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });

      // 3. Cost by Region (Stacked Bar)
      const regionCost = {};
      summary.forEach(r => {
        if (r.region && r.estimated_monthly_cost_usd != null) {
          regionCost[r.region] = (regionCost[r.region] || 0) + Number(r.estimated_monthly_cost_usd);
        }
      });
      const regionLabels = Object.keys(regionCost).sort();
      new Chart(document.getElementById('chart-region'), {
        type: 'bar',
        data: {
          labels: regionLabels,
          datasets: [{
            label: 'Total Cost ($)',
            data: regionLabels.map(r => regionCost[r]),
            backgroundColor: COLORS.amber,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // 4. Request Volume (Line - count per month)
      const monthCounts = {};
      summary.forEach(r => {
        if (r.created_at) {
          const d = new Date(r.created_at);
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          monthCounts[key] = (monthCounts[key] || 0) + 1;
        }
      });
      const monthLabels = Object.keys(monthCounts).sort();
      new Chart(document.getElementById('chart-volume'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Requests',
            data: monthLabels.map(m => monthCounts[m]),
            borderColor: COLORS.blue,
            backgroundColor: 'rgba(56, 189, 248, 0.1)',
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // 5. Time in State (Bar)
      const tsLabels = [];
      const tsValues = [];
      timeState.forEach(row => {
        tsLabels.push((row.event_type || '').replace(/_/g, ' '));
        tsValues.push(parseInterval(row.median_duration || row.avg_duration));
      });
      if (tsLabels.length === 0) {
        tsLabels.push('No data');
        tsValues.push(0);
      }
      new Chart(document.getElementById('chart-time-state'), {
        type: 'bar',
        data: {
          labels: tsLabels,
          datasets: [{
            label: 'Median Hours',
            data: tsValues,
            backgroundColor: COLORS.purple,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // 6. VP Escalation Rate (Doughnut)
      let escalated = 0, notEscalated = 0;
      summary.forEach(r => {
        if (r.escalation_required) escalated++;
        else notEscalated++;
      });
      new Chart(document.getElementById('chart-escalation'), {
        type: 'doughnut',
        data: {
          labels: ['Escalated', 'Not Escalated'],
          datasets: [{
            data: [escalated, notEscalated],
            backgroundColor: [COLORS.red, COLORS.green],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    init();
  </script>
</body>
</html>
