<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Confirm Request</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html">Dashboard</a>
        <a href="new.html">New Request</a>
      </nav>
      <span class="topbar-user" id="user-info"></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Sign in to confirm or decline this request.</p>
      <div class="input-group">
        <input type="email" id="email" placeholder="you@example.com">
        <button class="btn btn-primary" onclick="signIn()">Send Link</button>
      </div>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Customer Confirmation</h1>
        <p>Review and confirm the capacity request below</p>
      </div>

      <div id="msg"></div>

      <div class="card fade-in fade-in-1 mb-3">
        <div class="card-header">
          <h3>Request Summary</h3>
          <span id="state-badge"></span>
        </div>
        <div class="card-body">
          <div class="stat-row" id="stat-row">
            <div class="stat"><div class="stat-label">Loading</div><div class="stat-value loading">...</div></div>
          </div>
        </div>
      </div>

      <div class="actions fade-in fade-in-2" id="actions"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const params = new URLSearchParams(location.search);
    const requestId = params.get('id');

    async function init() {
      if (!requestId) { document.body.innerHTML = '<div class="shell"><div class="msg msg-error mt-3">No request ID provided.</div></div>'; return; }

      try {
        if (SUPABASE_ANON_KEY.includes('secret')) {
          showApp({ email: 'local-dev', id: 'local-dev' });
          return;
        }
        const { data: { session } } = await sb.auth.getSession();
        if (session) showApp(session.user);
        sb.auth.onAuthStateChange((_event, session) => {
          if (session) showApp(session.user);
        });
      } catch (e) {
        console.error('init error:', e);
        showApp({ email: 'fallback', id: 'fallback' });
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      const msg = document.getElementById('auth-msg');
      try {
        const { error } = await sb.auth.signInWithOtp({ email });
        msg.classList.remove('hidden');
        msg.className = error ? 'msg msg-error mt-2' : 'msg msg-success mt-2';
        msg.textContent = error ? error.message : 'Check your email for the magic link.';
      } catch (e) {
        console.error('signIn error:', e);
        msg.classList.remove('hidden');
        msg.className = 'msg msg-error mt-2';
        msg.textContent = e.message || 'Failed to send magic link. Please try again.';
      }
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-info').textContent = user.email;
      window._userId = user.id || user.email;
      await loadSummary();
    }

    async function loadSummary() {
      const { data: r, error } = await sb.from('capacity_requests')
        .select('*')
        .eq('id', requestId)
        .single();

      if (error) {
        document.getElementById('msg').innerHTML = `<div class="msg msg-error">${error.message}</div>`;
        return;
      }

      document.getElementById('state-badge').innerHTML = `<span class="badge badge-${r.state}">${fmtState(r.state)}</span>`;

      document.getElementById('stat-row').innerHTML = `
        <div class="stat">
          <div class="stat-label">Request ID</div>
          <div class="stat-value mono">${esc(r.id)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Size</div>
          <div class="stat-value mono">${esc(r.requested_size)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Region</div>
          <div class="stat-value mono">${esc(r.region)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Quantity</div>
          <div class="stat-value">${r.quantity}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Est. Cost</div>
          <div class="stat-value mono">${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '\u2014'}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Needed By</div>
          <div class="stat-value">${r.needed_by_date || '\u2014'}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Deadline</div>
          <div class="stat-value">${r.next_deadline_at ? fmtDate(r.next_deadline_at) : '\u2014'}</div>
        </div>
      `;

      const acts = document.getElementById('actions');
      if (r.state === 'CUSTOMER_CONFIRMATION_REQUIRED') {
        acts.innerHTML = `
          <button class="btn btn-success" onclick="respond('CUSTOMER_CONFIRMED')">Confirm</button>
          <button class="btn btn-danger"  onclick="respond('CUSTOMER_DECLINED')">Decline</button>
        `;
      } else {
        acts.innerHTML = `<div class="msg msg-info">This request is in state <strong>${fmtState(r.state)}</strong> and cannot be confirmed or declined.</div>`;
      }
    }

    async function respond(eventType) {
      const msgEl = document.getElementById('msg');
      msgEl.innerHTML = '';
      const actorId = window._userId || 'web-user';

      const { data, error } = await sb.rpc('apply_capacity_event', {
        p_request_id: requestId,
        p_event_type: eventType,
        p_actor_type: 'user',
        p_actor_id: actorId,
        p_payload: {}
      });
      if (error) {
        msgEl.innerHTML = `<div class="msg msg-error">${error.message}</div>`;
      } else {
        const label = eventType === 'CUSTOMER_CONFIRMED' ? 'confirmed' : 'declined';
        msgEl.innerHTML = `<div class="msg msg-success">Request ${label}. <a href="detail.html?id=${encodeURIComponent(requestId)}">View details</a></div>`;
        document.getElementById('actions').innerHTML = '';
        await loadSummary();
      }
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    function fmtDate(iso) {
      if (!iso) return '\u2014';
      return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function fmtState(s) {
      return (s || '').replace(/_/g, ' ');
    }

    init();
  </script>
</body>
</html>
