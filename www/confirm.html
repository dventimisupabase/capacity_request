<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Confirm Request</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html">Dashboard</a>
        <a href="new.html">New Request</a>
        <a href="queue.html">Queue <span class="nav-badge" id="queue-badge"></span></a>
        <a href="analytics.html">Analytics</a>
        <a href="about.html">About</a>
      </nav>
      <span class="topbar-user"><span id="user-info"></span><button class="topbar-signout" onclick="signOut()" title="Sign out">Sign out</button></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Sign in with your Slack workspace account.</p>
      <button class="btn btn-primary btn-slack" onclick="signInWithSlack()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.163 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.163 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.163 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.523 2.527 2.527 0 0 1 2.52-2.52h6.315A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.315z"/></svg>
        Sign in with Slack
      </button>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Customer Confirmation</h1>
        <p>Review and confirm the capacity request below</p>
      </div>

      <div id="msg"></div>

      <div class="card fade-in fade-in-1 mb-3">
        <div class="card-header">
          <h3>Request Summary</h3>
          <span id="state-badge"></span>
        </div>
        <div class="card-body">
          <div class="stat-row" id="stat-row">
            <div class="stat"><div class="stat-label">Loading</div><div class="stat-value loading">...</div></div>
          </div>
        </div>
      </div>

      <div class="form-group full fade-in fade-in-2" id="notes-group" style="margin-top:1rem;display:none;">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Add a note about your decision..."></textarea>
      </div>

      <div class="actions fade-in fade-in-2" id="actions"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const requestId = params.get('id');

    async function init() {
      if (!requestId) { document.body.innerHTML = '<div class="shell"><div class="msg msg-error mt-3">No request ID provided.</div></div>'; return; }
      await initAuth();
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      const displayName = user.user_metadata?.name || user.user_metadata?.full_name || user.email;
      document.getElementById('user-info').textContent = displayName;
      window._userId = getSlackUserId(user);
      await loadSummary();
    }

    async function loadSummary() {
      const { data: r, error } = await sb.from('capacity_requests')
        .select('*')
        .eq('id', requestId)
        .single();

      if (error) {
        document.getElementById('msg').innerHTML = `<div class="msg msg-error">${error.message}</div>`;
        return;
      }

      document.getElementById('state-badge').innerHTML = `<span class="badge badge-${r.state}">${fmtState(r.state)}</span>`;

      document.getElementById('stat-row').innerHTML = `
        <div class="stat">
          <div class="stat-label">Request ID</div>
          <div class="stat-value mono">${esc(r.id)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Size</div>
          <div class="stat-value mono">${esc(r.requested_size)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Region</div>
          <div class="stat-value mono">${esc(r.region)}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Quantity</div>
          <div class="stat-value">${r.quantity}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Est. Cost</div>
          <div class="stat-value mono">${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '\u2014'}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Needed By</div>
          <div class="stat-value">${r.needed_by_date || '\u2014'}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Deadline</div>
          <div class="stat-value">${r.next_deadline_at ? fmtDate(r.next_deadline_at) : '\u2014'}</div>
        </div>
      `;

      const acts = document.getElementById('actions');
      const notesGroup = document.getElementById('notes-group');
      if (r.state === 'CUSTOMER_CONFIRMATION_REQUIRED') {
        notesGroup.style.display = '';
        acts.innerHTML = `
          <button class="btn btn-success" onclick="respond('CUSTOMER_CONFIRMED')">Confirm</button>
          <button class="btn btn-danger"  onclick="respond('CUSTOMER_DECLINED')">Decline</button>
        `;
      } else {
        notesGroup.style.display = 'none';
        acts.innerHTML = `<div class="msg msg-info">This request is in state <strong>${fmtState(r.state)}</strong> and cannot be confirmed or declined.</div>`;
      }
    }

    async function respond(eventType) {
      const msgEl = document.getElementById('msg');
      msgEl.innerHTML = '';
      const actorId = window._userId || 'web-user';
      const notesEl = document.getElementById('notes');
      const notes = notesEl ? notesEl.value.trim() : '';

      const rpcParams = {
        p_request_id: requestId,
        p_event_type: eventType,
        p_actor_type: 'user',
        p_actor_id: actorId,
        p_payload: {}
      };
      if (notes) rpcParams.p_notes = notes;
      const { data, error } = await sb.rpc('apply_capacity_event', rpcParams);
      if (error) {
        msgEl.innerHTML = `<div class="msg msg-error">${error.message}</div>`;
      } else {
        const label = eventType === 'CUSTOMER_CONFIRMED' ? 'confirmed' : 'declined';
        msgEl.innerHTML = `<div class="msg msg-success">Request ${label}. <a href="detail.html?id=${encodeURIComponent(requestId)}">View details</a></div>`;
        document.getElementById('actions').innerHTML = '';
        await loadSummary();
      }
    }

    init();
  </script>
</body>
</html>
