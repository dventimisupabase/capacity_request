<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirm Capacity Request</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <span class="brand">Capacity Requests</span>
    <a href="index.html">Dashboard</a>
  </nav>

  <div id="auth">
    <p>Sign in to confirm or decline this request.</p>
    <input type="email" id="email" placeholder="you@example.com">
    <button class="btn btn-primary" onclick="signIn()">Send Magic Link</button>
    <p id="auth-msg" class="hidden"></p>
  </div>

  <div id="app" class="hidden">
    <h1>Customer Confirmation</h1>
    <div id="msg"></div>

    <div id="summary">
      <dl class="detail-grid" id="detail-grid">
        <dt>Loading...</dt><dd></dd>
      </dl>
    </div>

    <div class="actions" id="actions"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const params = new URLSearchParams(location.search);
    const requestId = params.get('id');

    async function init() {
      if (!requestId) { document.body.innerHTML = '<p class="msg msg-error">No request ID provided.</p>'; return; }

      const { data: { session } } = await sb.auth.getSession();
      if (session) showApp(session.user);
      sb.auth.onAuthStateChange((_event, session) => {
        if (session) showApp(session.user);
      });
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      const { error } = await sb.auth.signInWithOtp({ email });
      const msg = document.getElementById('auth-msg');
      msg.classList.remove('hidden');
      msg.className = error ? 'msg msg-error' : 'msg msg-success';
      msg.textContent = error ? error.message : 'Check your email for the magic link.';
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      await loadSummary();
    }

    async function loadSummary() {
      const { data: r, error } = await sb.from('capacity_requests')
        .select('*')
        .eq('id', requestId)
        .single();

      if (error) {
        document.getElementById('msg').innerHTML = `<div class="msg msg-error">${error.message}</div>`;
        return;
      }

      const grid = document.getElementById('detail-grid');
      grid.innerHTML = `
        <dt>Request ID</dt><dd>${esc(r.id)}</dd>
        <dt>State</dt><dd><span class="badge badge-${r.state}">${r.state}</span></dd>
        <dt>Size</dt><dd>${esc(r.requested_size)}</dd>
        <dt>Region</dt><dd>${esc(r.region)}</dd>
        <dt>Quantity</dt><dd>${r.quantity}</dd>
        <dt>Est. Cost</dt><dd>${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '—'}</dd>
        <dt>Needed By</dt><dd>${r.needed_by_date || '—'}</dd>
        <dt>Deadline</dt><dd>${r.next_deadline_at ? fmtDate(r.next_deadline_at) : '—'}</dd>
      `;

      const acts = document.getElementById('actions');
      if (r.state === 'CUSTOMER_CONFIRMATION_REQUIRED') {
        acts.innerHTML = `
          <button class="btn btn-success" onclick="respond('CUSTOMER_CONFIRMED')">Confirm</button>
          <button class="btn btn-danger"  onclick="respond('CUSTOMER_DECLINED')">Decline</button>
        `;
      } else {
        acts.innerHTML = `<div class="msg msg-info">This request is in state <strong>${r.state}</strong> and cannot be confirmed or declined.</div>`;
      }
    }

    async function respond(eventType) {
      const msgEl = document.getElementById('msg');
      msgEl.innerHTML = '';
      const { data: { user } } = await sb.auth.getUser();

      const { data, error } = await sb.rpc('apply_capacity_event', {
        p_request_id: requestId,
        p_event_type: eventType,
        p_actor_type: 'user',
        p_actor_id: user.id,
        p_payload: {}
      });
      if (error) {
        msgEl.innerHTML = `<div class="msg msg-error">${error.message}</div>`;
      } else {
        const label = eventType === 'CUSTOMER_CONFIRMED' ? 'confirmed' : 'declined';
        msgEl.innerHTML = `<div class="msg msg-success">Request ${label}. <a href="detail.html?id=${encodeURIComponent(requestId)}">View details</a></div>`;
        document.getElementById('actions').innerHTML = '';
        await loadSummary();
      }
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    function fmtDate(iso) {
      if (!iso) return '—';
      return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    init();
  </script>
</body>
</html>
