<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Request Detail</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html">Dashboard</a>
        <a href="new.html">New Request</a>
      </nav>
      <span class="topbar-user" id="user-info"></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Sign in to view request details.</p>
      <div class="input-group">
        <input type="email" id="email" placeholder="you@example.com">
        <button class="btn btn-primary" onclick="signIn()">Send Link</button>
      </div>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Request <span class="mono" id="req-id"></span></h1>
      </div>

      <div id="msg"></div>

      <!-- Request fields -->
      <div class="card fade-in fade-in-1 mb-3">
        <div class="card-header">
          <h3>Details</h3>
          <span id="state-badge"></span>
        </div>
        <div class="card-body">
          <div class="detail-grid" id="detail-grid">
            <div class="detail-item" style="grid-column:1/-1"><span class="loading">Loading...</span></div>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="actions fade-in fade-in-2" id="actions"></div>

      <!-- Events timeline -->
      <div class="fade-in fade-in-3 mt-3">
        <div class="section-label">Event Log</div>
        <ul class="timeline" id="timeline">
          <li class="loading">Loading events...</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const params = new URLSearchParams(location.search);
    const requestId = params.get('id');

    async function init() {
      if (!requestId) { document.body.innerHTML = '<div class="shell"><div class="msg msg-error mt-3">No request ID provided.</div></div>'; return; }
      document.getElementById('req-id').textContent = requestId;

      try {
        if (SUPABASE_ANON_KEY.includes('secret')) {
          showApp({ email: 'local-dev', id: 'local-dev' });
          return;
        }
        const { data: { session } } = await sb.auth.getSession();
        if (session) showApp(session.user);
        sb.auth.onAuthStateChange((_event, session) => {
          if (session) showApp(session.user);
        });
      } catch (e) {
        console.error('init error:', e);
        showApp({ email: 'fallback', id: 'fallback' });
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      const { error } = await sb.auth.signInWithOtp({ email });
      const msg = document.getElementById('auth-msg');
      msg.classList.remove('hidden');
      msg.className = error ? 'msg msg-error mt-2' : 'msg msg-success mt-2';
      msg.textContent = error ? error.message : 'Check your email for the magic link.';
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-info').textContent = user.email;
      window._userId = user.id || user.email;
      await loadDetail();
    }

    async function loadDetail() {
      const [reqResult, eventsResult] = await Promise.all([
        sb.from('capacity_requests').select('*').eq('id', requestId).single(),
        sb.from('capacity_request_events').select('*').eq('capacity_request_id', requestId).order('created_at', { ascending: true })
      ]);

      if (reqResult.error) {
        document.getElementById('msg').innerHTML = `<div class="msg msg-error">${reqResult.error.message}</div>`;
        return;
      }

      const r = reqResult.data;

      // State badge in card header
      document.getElementById('state-badge').innerHTML = `<span class="badge badge-${r.state}">${fmtState(r.state)}</span>`;

      const grid = document.getElementById('detail-grid');
      grid.innerHTML = `
        <div class="detail-item"><div class="detail-label">Region</div><div class="detail-value mono">${esc(r.region)}</div></div>
        <div class="detail-item"><div class="detail-label">Size</div><div class="detail-value mono">${esc(r.requested_size)}</div></div>
        <div class="detail-item"><div class="detail-label">Quantity</div><div class="detail-value">${r.quantity}</div></div>
        <div class="detail-item"><div class="detail-label">Est. Cost</div><div class="detail-value mono">${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Needed By</div><div class="detail-value">${r.needed_by_date || '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Duration</div><div class="detail-value">${r.expected_duration_days ? r.expected_duration_days + ' days' : '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Customer</div><div class="detail-value">${r.customer_ref ? esc(r.customer_ref.name || JSON.stringify(r.customer_ref)) : '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Requester</div><div class="detail-value mono">${esc(r.requester_user_id)}</div></div>
        <div class="detail-item"><div class="detail-label">Commercial</div><div class="detail-value mono">${esc(r.commercial_owner_user_id) || '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Infra Group</div><div class="detail-value mono">${esc(r.infra_owner_group) || '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Created</div><div class="detail-value">${fmtDate(r.created_at)}</div></div>
        <div class="detail-item"><div class="detail-label">Updated</div><div class="detail-value">${fmtDate(r.updated_at)}</div></div>
        <div class="detail-item"><div class="detail-label">Deadline</div><div class="detail-value">${r.next_deadline_at ? fmtDate(r.next_deadline_at) : '\u2014'}</div></div>
        <div class="detail-item"><div class="detail-label">Version</div><div class="detail-value mono">${r.version}</div></div>
      `;

      // Action buttons
      const acts = document.getElementById('actions');
      acts.innerHTML = '';
      const state = r.state;

      if (state === 'UNDER_REVIEW') {
        acts.innerHTML = `
          <button class="btn btn-success" onclick="applyEvent('COMMERCIAL_APPROVED')">Commercial Approve</button>
          <button class="btn btn-danger"  onclick="applyEvent('COMMERCIAL_REJECTED')">Commercial Reject</button>
          <button class="btn btn-success" onclick="applyEvent('TECH_REVIEW_APPROVED')">Tech Approve</button>
          <button class="btn btn-danger"  onclick="applyEvent('TECH_REVIEW_REJECTED')">Tech Reject</button>
          <button class="btn btn-success" onclick="applyEvent('VP_APPROVED')">VP Approve</button>
          <button class="btn btn-danger"  onclick="applyEvent('VP_REJECTED')">VP Reject</button>
        `;
      }
      if (state === 'CUSTOMER_CONFIRMATION_REQUIRED') {
        acts.innerHTML = `
          <button class="btn btn-success" onclick="applyEvent('CUSTOMER_CONFIRMED')">Confirm</button>
          <button class="btn btn-danger"  onclick="applyEvent('CUSTOMER_DECLINED')">Decline</button>
        `;
      }
      if (!['COMPLETED', 'REJECTED', 'CANCELLED', 'EXPIRED', 'FAILED'].includes(state)) {
        acts.innerHTML += `<button class="btn btn-ghost" onclick="cancelRequest()">Cancel Request</button>`;
      }

      // Events timeline
      const tl = document.getElementById('timeline');
      if (eventsResult.error || !eventsResult.data.length) {
        tl.innerHTML = '<li>No events found.</li>';
      } else {
        tl.innerHTML = eventsResult.data.map(e => `
          <li>
            <span class="event-type">${fmtState(e.event_type)}</span>
            <span class="event-meta"> \u2014 ${e.actor_type}:${esc(e.actor_id)} at ${fmtDate(e.created_at)}</span>
            ${e.payload && Object.keys(e.payload).length ? '<div class="event-payload">' + esc(JSON.stringify(e.payload)) + '</div>' : ''}
          </li>
        `).join('');
      }
    }

    async function applyEvent(eventType, payload) {
      const msgEl = document.getElementById('msg');
      msgEl.innerHTML = '';
      const actorId = window._userId || 'web-user';
      const { data, error } = await sb.rpc('apply_capacity_event', {
        p_request_id: requestId,
        p_event_type: eventType,
        p_actor_type: 'user',
        p_actor_id: actorId,
        p_payload: payload || {}
      });
      if (error) {
        msgEl.innerHTML = `<div class="msg msg-error">${error.message}</div>`;
      } else {
        msgEl.innerHTML = `<div class="msg msg-success">Event ${fmtState(eventType)} applied.</div>`;
        await loadDetail();
      }
    }

    async function cancelRequest() {
      const reason = prompt('Cancellation reason (optional):');
      if (reason === null) return;
      await applyEvent('CANCEL_APPROVED', { reason: reason || 'Cancelled via web UI' });
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    function fmtDate(iso) {
      if (!iso) return '\u2014';
      return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function fmtState(s) {
      return (s || '').replace(/_/g, ' ');
    }

    init();
  </script>
</body>
</html>
