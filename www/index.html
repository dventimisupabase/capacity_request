<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Capacity Requests</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html" class="active">Dashboard</a>
        <a href="new.html">New Request</a>
      </nav>
      <span class="topbar-user" id="user-info"></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Enter your email to sign in.</p>
      <div class="input-group">
        <input type="email" id="email" placeholder="you@example.com">
        <button class="btn btn-primary" onclick="signIn()">Send Link</button>
      </div>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Dashboard</h1>
        <p>Manage infrastructure capacity requests with approvals</p>
      </div>

      <div id="msg"></div>

      <div class="card fade-in fade-in-1">
        <div class="card-header">
          <h3>Requests</h3>
          <a href="new.html" class="btn btn-primary" style="padding:0.35rem 0.75rem;font-size:0.78rem;">+ New</a>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>State</th>
              <th>Region</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Est. Cost</th>
              <th>Created</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="requests-body">
            <tr class="empty-row"><td colspan="8" class="loading">Loading requests...</td></tr>
          </tbody>
        </table>
      </div>

      <footer class="app-footer fade-in fade-in-3">
        <p>Create requests via <code>/capacity</code> in Slack or the web form. Track them through commercial review, technical review, optional VP escalation, customer confirmation, and provisioning.</p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function init() {
      try {
        if (SUPABASE_ANON_KEY.includes('secret')) {
          showApp({ email: 'local-dev' });
          return;
        }
        const { data: { session } } = await sb.auth.getSession();
        if (session) showApp(session.user);
        sb.auth.onAuthStateChange((_event, session) => {
          if (session) showApp(session.user);
        });
      } catch (e) {
        console.error('init error:', e);
        showApp({ email: 'fallback' });
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      const msg = document.getElementById('auth-msg');
      try {
        const { error } = await sb.auth.signInWithOtp({ email });
        msg.classList.remove('hidden');
        msg.className = error ? 'msg msg-error mt-2' : 'msg msg-success mt-2';
        msg.textContent = error ? error.message : 'Check your email for the magic link.';
      } catch (e) {
        console.error('signIn error:', e);
        msg.classList.remove('hidden');
        msg.className = 'msg msg-error mt-2';
        msg.textContent = e.message || 'Failed to send magic link. Please try again.';
      }
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-info').textContent = user.email;
      await loadRequests();
    }

    async function loadRequests() {
      const { data, error } = await sb.from('v_request_summary')
        .select('*')
        .order('created_at', { ascending: false });

      const tbody = document.getElementById('requests-body');
      if (error) {
        tbody.innerHTML = `<tr class="empty-row"><td colspan="8" class="msg-error">${error.message}</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="8">No requests found.</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(r => `
        <tr onclick="location.href='detail.html?id=${encodeURIComponent(r.id)}'">
          <td class="col-id">${esc(r.id)}</td>
          <td><span class="badge badge-${r.state}">${fmtState(r.state)}</span></td>
          <td class="col-mono">${esc(r.region)}</td>
          <td class="col-mono">${esc(r.requested_size)}</td>
          <td>${r.quantity}</td>
          <td class="col-cost">${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '<span style="color:var(--text-dim)">\u2014</span>'}</td>
          <td class="col-date">${fmtDate(r.created_at)}</td>
          <td class="col-date">${fmtDate(r.updated_at)}</td>
        </tr>
      `).join('');
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function fmtDate(iso) {
      if (!iso) return '\u2014';
      return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function fmtState(s) {
      return (s || '').replace(/_/g, ' ');
    }

    init();
  </script>
</body>
</html>
