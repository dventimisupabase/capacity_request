<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapReq â€” Capacity Requests</title>
  <link rel="icon" type="image/png" href="capreq-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="capreq-icon.png" alt="CapReq" class="topbar-icon">
        <span>CapReq</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html" class="active">Dashboard</a>
        <a href="new.html">New Request</a>
        <a href="queue.html">Queue <span class="nav-badge" id="queue-badge"></span></a>
        <a href="analytics.html">Analytics</a>
      </nav>
      <span class="topbar-user" id="user-info"></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="capreq-icon.png" alt="CapReq" class="auth-logo">
      <h2>CapReq</h2>
      <p class="auth-tagline">Manage infrastructure capacity requests with approvals</p>
      <p>Sign in with your Slack workspace account.</p>
      <button class="btn btn-primary btn-slack" onclick="signInWithSlack()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.163 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.163 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.163 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.523 2.527 2.527 0 0 1 2.52-2.52h6.315A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.315z"/></svg>
        Sign in with Slack
      </button>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Dashboard</h1>
        <p>Manage infrastructure capacity requests with approvals</p>
      </div>

      <div id="msg"></div>

      <div class="card fade-in fade-in-1">
        <div class="card-header">
          <h3>Requests</h3>
          <a href="new.html" class="btn btn-primary" style="padding:0.35rem 0.75rem;font-size:0.78rem;">+ New</a>
        </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label for="filter-state">State</label>
            <select id="filter-state">
              <option value="">All</option>
              <option value="SUBMITTED">Submitted</option>
              <option value="UNDER_REVIEW">Under Review</option>
              <option value="CUSTOMER_CONFIRMATION_REQUIRED">Customer Confirmation</option>
              <option value="PROVISIONING">Provisioning</option>
              <option value="COMPLETED">Completed</option>
              <option value="REJECTED">Rejected</option>
              <option value="CANCELLED">Cancelled</option>
              <option value="EXPIRED">Expired</option>
              <option value="FAILED">Failed</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-region">Region</label>
            <select id="filter-region">
              <option value="">All</option>
              <option value="us-east-1">us-east-1</option>
              <option value="us-east-2">us-east-2</option>
              <option value="us-west-1">us-west-1</option>
              <option value="us-west-2">us-west-2</option>
              <option value="eu-west-1">eu-west-1</option>
              <option value="eu-west-2">eu-west-2</option>
              <option value="eu-central-1">eu-central-1</option>
              <option value="ap-southeast-1">ap-southeast-1</option>
              <option value="ap-northeast-1">ap-northeast-1</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-search">Search</label>
            <input type="text" id="filter-search" placeholder="ID or customer...">
          </div>
          <div class="filter-group">
            <label for="filter-range">Date Range</label>
            <select id="filter-range">
              <option value="">All time</option>
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
          <div class="filter-actions">
            <button class="btn btn-ghost" onclick="clearFilters()">Clear</button>
          </div>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>State</th>
              <th>Region</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Est. Cost</th>
              <th>Created</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="requests-body">
            <tr class="empty-row"><td colspan="8" class="loading">Loading requests...</td></tr>
          </tbody>
        </table>
      </div>

      <footer class="app-footer fade-in fade-in-3">
        <p>Create requests via <code>/capacity</code> in Slack or the web form. Track them through commercial review, technical review, optional VP escalation, customer confirmation, and provisioning.</p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let allRequests = [];
    const TERMINAL_STATES = ['COMPLETED', 'REJECTED', 'CANCELLED', 'EXPIRED', 'FAILED'];

    async function init() {
      try {
        if (SUPABASE_ANON_KEY.includes('secret')) {
          showApp({ email: 'local-dev', id: 'local-dev' });
          return;
        }
        const { data: { session } } = await sb.auth.getSession();
        if (session) showApp(session.user);
        sb.auth.onAuthStateChange((_event, session) => {
          if (session) showApp(session.user);
        });
      } catch (e) {
        console.error('init error:', e);
        showApp({ email: 'fallback', id: 'fallback' });
      }
    }

    async function signInWithSlack() {
      const { data, error } = await sb.auth.signInWithOAuth({
        provider: 'slack_oidc',
        options: { redirectTo: window.location.href }
      });
      if (error) {
        const msg = document.getElementById('auth-msg');
        msg.classList.remove('hidden');
        msg.className = 'msg msg-error mt-2';
        msg.textContent = error.message;
      }
    }

    function getSlackUserId(user) {
      if (user.user_metadata?.provider_id) return user.user_metadata.provider_id;
      const slack = user.identities?.find(i => i.provider === 'slack_oidc');
      if (slack?.identity_data?.provider_id) return slack.identity_data.provider_id;
      if (user.user_metadata?.sub) return user.user_metadata.sub;
      return user.id || user.email;
    }

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      const displayName = user.user_metadata?.name || user.user_metadata?.full_name || user.email;
      document.getElementById('user-info').textContent = displayName;
      window._userId = getSlackUserId(user);
      initFilters();
      await loadRequests();
      loadQueueBadge();
    }

    function initFilters() {
      const p = new URLSearchParams(location.search);
      if (p.get('state')) document.getElementById('filter-state').value = p.get('state');
      if (p.get('region')) document.getElementById('filter-region').value = p.get('region');
      if (p.get('q')) document.getElementById('filter-search').value = p.get('q');
      if (p.get('range')) document.getElementById('filter-range').value = p.get('range');

      document.getElementById('filter-state').addEventListener('change', applyFilters);
      document.getElementById('filter-region').addEventListener('change', applyFilters);
      document.getElementById('filter-search').addEventListener('input', applyFilters);
      document.getElementById('filter-range').addEventListener('change', applyFilters);
    }

    function applyFilters() {
      const state = document.getElementById('filter-state').value;
      const region = document.getElementById('filter-region').value;
      const q = document.getElementById('filter-search').value.trim().toLowerCase();
      const range = document.getElementById('filter-range').value;

      const p = new URLSearchParams();
      if (state) p.set('state', state);
      if (region) p.set('region', region);
      if (q) p.set('q', q);
      if (range) p.set('range', range);
      const qs = p.toString();
      history.replaceState(null, '', qs ? '?' + qs : location.pathname);

      renderRequests(filterRequests(state, region, q, range));
    }

    function filterRequests(state, region, q, range) {
      let filtered = allRequests;
      if (state) filtered = filtered.filter(r => r.state === state);
      if (region) filtered = filtered.filter(r => r.region === region);
      if (q) {
        filtered = filtered.filter(r => {
          const id = (r.id || '').toLowerCase();
          const name = (r.customer_ref && r.customer_ref.name ? r.customer_ref.name : '').toLowerCase();
          return id.includes(q) || name.includes(q);
        });
      }
      if (range) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - parseInt(range));
        filtered = filtered.filter(r => new Date(r.created_at) >= cutoff);
      }
      return filtered;
    }

    function clearFilters() {
      document.getElementById('filter-state').value = '';
      document.getElementById('filter-region').value = '';
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-range').value = '';
      history.replaceState(null, '', location.pathname);
      renderRequests(allRequests);
    }

    function getAgeClass(r) {
      if (TERMINAL_STATES.includes(r.state)) return '';
      const hours = (Date.now() - new Date(r.created_at).getTime()) / 3600000;
      if (hours < 24) return 'age-green';
      if (hours < 72) return 'age-amber';
      return 'age-red';
    }

    async function loadRequests() {
      const { data, error } = await sb.from('v_request_summary')
        .select('*')
        .order('created_at', { ascending: false });

      const tbody = document.getElementById('requests-body');
      if (error) {
        tbody.innerHTML = `<tr class="empty-row"><td colspan="8" class="msg-error">${error.message}</td></tr>`;
        return;
      }
      allRequests = data || [];
      applyFilters();
    }

    function renderRequests(data) {
      const tbody = document.getElementById('requests-body');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="8">No requests found.</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(r => `
        <tr class="${getAgeClass(r)}" onclick="location.href='detail.html?id=${encodeURIComponent(r.id)}'">
          <td class="col-id">${esc(r.id)}</td>
          <td><span class="badge badge-${r.state}">${fmtState(r.state)}</span></td>
          <td class="col-mono">${esc(r.region)}</td>
          <td class="col-mono">${esc(r.requested_size)}</td>
          <td>${r.quantity}</td>
          <td class="col-cost">${r.estimated_monthly_cost_usd != null ? '$' + Number(r.estimated_monthly_cost_usd).toLocaleString() : '<span style="color:var(--text-dim)">\u2014</span>'}</td>
          <td class="col-date">${fmtDate(r.created_at)}</td>
          <td class="col-date">${fmtDate(r.updated_at)}</td>
        </tr>
      `).join('');
    }

    async function loadQueueBadge() {
      try {
        const userId = window._userId || 'web-user';
        const { data, error } = await sb.rpc('get_my_pending_actions', { p_user_id: userId });
        if (!error && data && data.length > 0) {
          document.getElementById('queue-badge').textContent = data.length;
        }
      } catch (e) {
        // Queue badge is non-critical
      }
    }

    function esc(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function fmtDate(iso) {
      if (!iso) return '\u2014';
      return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function fmtState(s) {
      return (s || '').replace(/_/g, ' ');
    }

    init();
  </script>
</body>
</html>
